<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ewidencja sprzedaży — mobilnie</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b5fff">

  <!-- jsPDF CDN (do generowania PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-+bnu2Q5Gv9fE7R6m6C6z3qkYv2tGKIq8T2SxQ6gkqJ2fS8I9gO/8V8k7D1+XbWa1yCw3aJ2r8B0Q9bI7uZ7rQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root {
      --bg: #f6f8ff;
      --card: #ffffff;
      --accent: #0b5fff;
      --muted: #6b7280;
    }
    html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:var(--bg); color:#111;}
    .app {
      max-width:720px;
      margin:0 auto;
      padding:18px;
    }
    header {
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    h1 { font-size:18px; margin:0; }
    .total {
      background:var(--card);
      padding:12px 16px; border-radius:10px;
      box-shadow: 0 6px 20px rgba(11,95,255,0.06);
      text-align:center;
      min-width:140px;
    }
    .total .label { font-size:12px; color:var(--muted); }
    .total .value { font-size:20px; font-weight:700; margin-top:6px; color:var(--accent); }

    .card {
      background:var(--card); padding:14px; border-radius:12px; box-shadow: 0 6px 18px rgba(16,24,40,0.04);
      margin-bottom:12px;
    }

    .input-row { display:flex; gap:8px; align-items:center; }
    input[type="number"] {
      -webkit-appearance: none;
      appearance: none;
      border:1px solid #e6e9f2; padding:12px; border-radius:8px; font-size:16px; flex:1;
    }
    button {
      background:var(--accent); color:white; border:0; padding:12px 14px; border-radius:10px; font-weight:600;
      font-size:15px;
    }
    button.secondary {
      background:transparent; border:1px solid #e6e9f2; color:#111;
    }

    .entries {
      max-height: 50vh; overflow:auto; padding-right:6px;
    }
    .entry {
      display:flex; justify-content:space-between; gap:12px; padding:10px 8px; border-bottom:1px solid #f1f3f8;
    }
    .entry .meta { color:var(--muted); font-size:13px; }
    .entry .amount { font-weight:700; color:#111; }

    footer { text-align:center; color:var(--muted); font-size:13px; margin-top:8px; }
    .small { font-size:12px; color:var(--muted); margin-top:6px; }

    /* large save area for thumbs */
    .big {
      display:block; width:100%; padding:14px; font-size:18px; border-radius:10px;
    }

    .controls { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    @media (max-width:420px) {
      .total { min-width:120px; padding:10px; }
      .input-row { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Ewidencja — szybki wpis</h1>
        <div class="small">Wpisujesz tylko kwotę — reszta jest automatyczna</div>
      </div>
      <div class="total card" aria-live="polite">
        <div class="label">Suma przychodów</div>
        <div id="total" class="value">0,00 zł</div>
      </div>
    </header>

    <section class="card">
      <div class="input-row" role="form" aria-label="Formularz wpisu">
        <input id="amount" type="number" inputmode="decimal" step="0.01" placeholder="Kwota (np. 49.99)" aria-label="Kwota" />
        <button id="saveBtn" class="big">Zapisz przychód</button>
      </div>

      <div class="controls">
        <button id="pdfBtn" class="secondary">Pobierz PDF</button>
        <button id="exportBtn" class="secondary">Utwórz kopię (JSON)</button>
        <label class="small" style="margin-left:auto">Dane są zapisywane lokalnie i nie można ich usuwać z aplikacji.</label>
      </div>
    </section>

    <section id="listSection" class="card">
      <h2 style="margin:0 0 8px 0; font-size:15px;">Historia (najstarsze → najnowsze)</h2>
      <div id="entries" class="entries" aria-live="polite"></div>
    </section>

    <footer>
      <div>Instrukcja: dodaj do ekranu głównego i używaj jak aplikacji. Możesz pobrać PDF lub zapasową kopię JSON.</div>
    </footer>
  </div>

<script>
/*
  Prosta warstwa IndexedDB:
  DB: salesDB, store: entries (keyPath: id autoIncrement)
  entry: { id, timestampISO, amountNumber }
*/
(function(){
  const DB_NAME = 'salesDB';
  const DB_VERSION = 1;
  const STORE = 'entries';
  let db;

  function openDB(){
    return new Promise((res, rej) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains(STORE)) {
          const os = d.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
          os.createIndex('timestamp', 'timestampISO', { unique: false });
        }
      };
      req.onsuccess = () => { db = req.result; res(db); };
      req.onerror = () => rej(req.error);
    });
  }

  function addEntry(amount){
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, 'readwrite');
      const store = tx.objectStore(STORE);
      const now = new Date();
      const rec = { timestampISO: now.toISOString(), amount: Number(amount) };
      const op = store.add(rec);
      op.onsuccess = () => res(op.result);
      op.onerror = () => rej(op.error);
    });
  }

  function getAllEntries(){
    return new Promise((res, rej) => {
      const tx = db.transaction(STORE, 'readonly');
      const store = tx.objectStore(STORE);
      const req = store.getAll();
      req.onsuccess = () => res(req.result || []);
      req.onerror = () => rej(req.error);
    });
  }

  // UI helpers
  const amountInput = document.getElementById('amount');
  const saveBtn = document.getElementById('saveBtn');
  const entriesEl = document.getElementById('entries');
  const totalEl = document.getElementById('total');
  const pdfBtn = document.getElementById('pdfBtn');
  const exportBtn = document.getElementById('exportBtn');

  function formatCurrency(n){
    if (isNaN(n)) n = 0;
    return Number(n).toLocaleString('pl-PL', { style:'currency', currency:'PLN' });
  }
  function formatDate(iso){
    const d = new Date(iso);
    return d.toLocaleString('pl-PL', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  }

  async function refreshUI(){
    const all = await getAllEntries();
    // sort by id (oldest first)
    all.sort((a,b) => a.id - b.id);
    entriesEl.innerHTML = '';
    let sum = 0;
    for (const e of all){
      sum += Number(e.amount || 0);
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `<div>
        <div class="meta">${formatDate(e.timestampISO)}</div>
      </div>
      <div class="amount">${formatCurrency(e.amount)}</div>`;
      entriesEl.appendChild(div);
    }
    totalEl.textContent = formatCurrency(sum);
  }

  // initialize DB then UI
  openDB().then(async () => {
    await refreshUI();
  }).catch(err => {
    console.error('DB error', err);
    alert('Błąd inicjalizacji lokalnej bazy danych. Spróbuj odświeżyć stronę.');
  });

  // Save handler
  saveBtn.addEventListener('click', async () => {
    const raw = amountInput.value.trim();
    if (!raw) { navigator.vibrate?.(100); amountInput.focus(); return; }
    const v = Number(raw);
    if (isNaN(v) || !isFinite(v)) { alert('Wprowadź poprawną kwotę.'); return; }
    // round to 2 decimals
    const rounded = Math.round(v * 100) / 100;
    try {
      await addEntry(rounded);
      amountInput.value = '';
      await refreshUI();
      // optional haptic / feedback
      try { navigator.vibrate?.(50); } catch(e){}
    } catch(err) {
      console.error(err);
      alert('Nie udało się zapisać. Sprawdź uprawnienia przeglądarki.');
    }
  });

  // PDF generation using jsPDF
  pdfBtn.addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const all = await getAllEntries();
    all.sort((a,b) => a.id - b.id);

    doc.setFontSize(14);
    doc.text('Ewidencja sprzedaży', 40, 50);
    doc.setFontSize(10);
    doc.text('Wygenerowano: ' + new Date().toLocaleString('pl-PL'), 40, 68);

    // table header
    const startY = 95;
    const col1 = 40, col2 = 320;
    doc.setFontSize(11);
    doc.text('Data i godzina', col1, startY);
    doc.text('Kwota', col2, startY);

    let y = startY + 18;
    let sum = 0;
    const lineHeight = 16;
    for (let i=0;i<all.length;i++){
      const e = all[i];
      const date = formatDate(e.timestampISO);
      const amt = formatCurrency(e.amount);
      doc.text(date, col1, y);
      doc.text(amt, col2, y);
      y += lineHeight;
      sum += Number(e.amount || 0);
      if (y > 770) {
        doc.addPage();
        y = 50;
      }
    }
    doc.setFontSize(12);
    doc.text('Suma: ' + formatCurrency(sum), col1, y + 18);

    // trigger download
    doc.save('ewidencja_przychodow.pdf');
  });

  // Export JSON backup
  exportBtn.addEventListener('click', async () => {
    const all = await getAllEntries();
    const blob = new Blob([JSON.stringify({ exportedAt: new Date().toISOString(), entries: all }, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ewidencja_backup.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // register service worker for offline caching (optional)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(()=>{/*ignore*/});
  }

  // Accessibility: handle Enter on input
  amountInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      saveBtn.click();
    }
  });

})();
</script>
</body>
</html>